<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Foundation Kaleosu — Chat com Dropdown</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,sans-serif;}
body{background-color:#121212;display:flex;justify-content:center;align-items:center;height:100vh;color:#E1E1E1;}
.container{width:100%;max-width:480px;background-color:#1E1E1E;border-radius:10px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.7);}
.form-container{padding:20px;display:flex;flex-direction:column;gap:12px;}
input, textarea, select{padding:10px;border-radius:6px;border:1px solid #333;outline:none;width:100%;font-size:14px;background-color:#2C2C2C;color:#E1E1E1;}
button{padding:10px;border:none;border-radius:6px;background-color:#075E54;color:#E1E1E1;font-weight:bold;cursor:pointer;transition:0.18s;}
button:hover{background-color:#056162;}
.link{color:#075E54;text-align:center;cursor:pointer;font-size:14px;}
.whatsapp-container{display:none;flex-direction:column;height:100vh;}
.header{height:60px;background-color:#1E1E1E;color:#E1E1E1;display:flex;align-items:center;padding:0 12px;font-weight:bold;font-size:18px;justify-content:space-between;box-shadow:0 2px 4px rgba(0,0,0,0.5);}
.contacts,.chat{flex:1;overflow-y:auto;background-color:#121212;-webkit-overflow-scrolling:touch;}
.contact{display:flex;align-items:center;padding:12px;border-bottom:1px solid #333;cursor:pointer;transition:0.18s;position:relative;}
.contact:hover{background-color:#2C2C2C;}
.avatar{width:46px;height:46px;border-radius:50%;background-color:#075E54;color:#E1E1E1;display:flex;justify-content:center;align-items:center;font-weight:bold;font-size:18px;margin-right:10px;position:relative;}
.status-dot{position:absolute;bottom:3px;right:3px;width:12px;height:12px;border-radius:50%;border:2px solid #1E1E1E;}
.name{font-weight:bold;font-size:15px;color:#E1E1E1;}
.unread-count{position:absolute;top:8px;right:10px;background:red;color:#fff;font-size:12px;padding:2px 6px;border-radius:12px;display:none;}
.chat{display:none;flex-direction:column;background-color:#121212;}
.chat-messages{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;scroll-behavior:smooth;}
.message-container{margin-bottom:12px;display:flex;flex-direction:column;max-width:75%;word-wrap:break-word;white-space:pre-wrap;}
.message-container.sent{align-self:flex-end;}
.message-container.received{align-self:flex-start;}
.sender-name{font-size:12px;font-weight:bold;color:#075E54;margin-bottom:6px;}
.message{font-size:14px;padding:10px 14px;border-radius:12px;display:inline-block;max-width:100%;white-space:pre-wrap;}
.message.sent{background-color:#056162;color:#E1E1E1;}
.message.received{background-color:#262D31;color:#E1E1E1;}
.message-time{font-size:10px;color:#888;text-align:right;margin-top:4px;}
.chat-input{display:flex;padding:10px;background-color:#2C2C2C;border-top:1px solid #333;}
.chat-input textarea{flex:1;padding:10px;border-radius:25px;border:1px solid #333;outline:none;font-size:14px;background-color:#1E1E1E;color:#E1E1E1;resize:none;height:44px;}
.chat-input button{background-color:#075E54;color:#E1E1E1;border:none;padding:10px 14px;margin-left:8px;border-radius:8px;cursor:pointer;}
.typing-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;background:yellow;margin-left:6px;animation:blink 1s infinite;}
@keyframes blink{0%,50%,100%{opacity:0;}25%,75%{opacity:1;}}
.small-note{font-size:12px;color:#bbb;text-align:center;padding:8px;}
</style>
</head>
<body>
<div class="container">

  <!-- LOGIN -->
  <div id="loginForm" class="form-container">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Senha">
    <button id="loginBtn">Entrar</button>
    <div class="link" id="showRegisterLink">Criar conta</div>
  </div>

  <!-- REGISTRO -->
  <div id="registerForm" class="form-container" style="display:none;">
    <h2>Cadastro</h2>
    <input type="text" id="regName" placeholder="Nome de usuário">
    <input type="email" id="regEmail" placeholder="Email">
    <input type="password" id="regPassword" placeholder="Senha">
    <input type="text" id="regGroup" placeholder="Função (ex: Professor, Aluno, Zero Absoluto)">
    <button id="registerBtn">Cadastrar</button>
    <div class="link" id="showLoginLink">Já tem conta? Entrar</div>
    <div class="small-note">Ao cadastrar com uma "Função" nova, a aba correspondente será criada automaticamente.</div>
  </div>

  <!-- CHAT -->
  <div class="whatsapp-container" id="whatsappApp">
    <div class="header">
      <span>Foundation Kaleosu</span>
      <div>
        <button id="logoutBtn" style="background:none; color:#E1E1E1; font-size:14px; border:none; cursor:pointer;">Sair</button>
        <button class="clear-chat" id="clearChatBtn">Apagar Chat</button>
      </div>
    </div>

    <div class="contacts">
      <select id="groupSelect"></select>
      <div id="contactsListContent"></div>
    </div>

    <div class="chat" id="chat">
      <div class="header">
        <span id="chatHeader">Chat Público</span>
        <button id="closeChatBtn" style="background:none; color:#E1E1E1; font-size:18px; border:none; cursor:pointer;">✖</button>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <textarea id="messageInput" placeholder="Digite uma mensagem..."></textarea>
        <button id="sendMsgBtn">➤</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, set, get, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMr3KcqWq358YvERVBkSqzDsqHnqsBqCw",
  authDomain: "chat-publico-foundation.firebaseapp.com",
  databaseURL: "https://chat-publico-foundation-default-rtdb.firebaseio.com",
  projectId: "chat-publico-foundation",
  storageBucket: "chat-publico-foundation.appspot.com",
  messagingSenderId: "1028294779813",
  appId: "1:1028294779813:web:a5fbdc8f5a7bb6c91abe4c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUserName = '';
let currentChat = 'Chat Público';
let currentGroup = 'Chat Público';
let messagesListenerUnsub = null;
let usersListenerRefs = [];
const userDomMap = {};
let groupsMap = new Map();
let typingTimeout = null;

/* ---------- AUTENTICAÇÃO ---------- */
onAuthStateChanged(auth, async user => {
  if(user){
    const snap = await get(ref(db,'users/'+user.uid));
    currentUserName = snap.exists()? snap.val().name || 'Usuário':'Usuário';
    document.getElementById('loginForm').style.display='none';
    document.getElementById('registerForm').style.display='none';
    document.getElementById('whatsappApp').style.display='flex';

    // Reset mapas e listeners
    groupsMap = new Map();
    Object.keys(userDomMap).forEach(k=>delete userDomMap[k]);
    usersListenerRefs.forEach(unsub=>unsub && unsub());
    usersListenerRefs = [];

    const userStatusRef = ref(db,'users/'+user.uid+'/status');
    await set(userStatusRef,'online');
    onDisconnect(userStatusRef).set('offline');

    setupContactsRealtime();
    updateGroupSelect();
    showTab('Chat Público');
    openChat('Chat Público','Chat Público');
  } else {
    document.getElementById('whatsappApp').style.display='none';
    document.getElementById('loginForm').style.display='flex';
  }
});

/* ---------- LOGIN / CADASTRO ---------- */
function showRegister(){document.getElementById('loginForm').style.display='none'; document.getElementById('registerForm').style.display='flex';}
function showLogin(){document.getElementById('loginForm').style.display='flex'; document.getElementById('registerForm').style.display='none';}

async function registerUser(){
  const name=document.getElementById('regName').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const password=document.getElementById('regPassword').value;
  const userGroup=document.getElementById('regGroup').value.trim() || 'Outro';
  if(!name || !email || !password){ alert('Preencha todos os campos!'); return; }
  try {
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    await set(ref(db,'users/'+cred.user.uid),{ name,email,userGroup,status:'offline',createdAt:Date.now() });
    alert(`Usuário "${name}" criado na função "${userGroup}". Faça login.`);
    showLogin();
  } catch(err){alert(err.message || String(err));}
}

async function loginUser(){
  const email=document.getElementById('loginEmail').value.trim();
  const password=document.getElementById('loginPassword').value;
  try{await signInWithEmailAndPassword(auth,email,password);} catch(err){alert(err.message||String(err));}
}

function logout(){
  if(!auth.currentUser) return;
  update(ref(db,'users/'+auth.currentUser.uid),{status:'offline'}).finally(()=>signOut(auth));
}

/* ---------- CONTATOS E GRUPOS ---------- */
function setupContactsRealtime(){
  const contactsList = document.getElementById('contactsListContent');
  contactsList.innerHTML='';

  function createGroupIfNeeded(groupName){
    if(groupsMap.has(groupName)) return groupsMap.get(groupName);
    const contentDiv = document.createElement('div'); contentDiv.className='tab-content';
    contactsList.appendChild(contentDiv);
    const obj = { contentDiv }; groupsMap.set(groupName,obj);
    updateGroupSelect();
    return obj;
  }

  createGroupIfNeeded('Chat Público');

  function createPublicChatContact(){
    const groupDom = groupsMap.get('Chat Público'); if(!groupDom) return;
    const div=document.createElement('div'); div.className='contact'; div.dataset.uid='public'; div.dataset.name='Chat Público';
    div.innerHTML = `<div class="avatar">🌐<div class="status-dot" style="background-color:green"></div></div><div class="name">Chat Público</div><div class="unread-count" id="unread-public"></div>`;
    div.addEventListener('click',()=>{currentChat='Chat Público'; openChat('Chat Público','Chat Público'); resetUnread('Chat Público');});
    groupDom.contentDiv.appendChild(div);
  }
  createPublicChatContact();

  function addOrUpdateUser(uid,userObj){
    if(!userObj) return; if(uid===auth.currentUser?.uid) return;
    const group = userObj.userGroup || 'Outro';
    const groupDom = createGroupIfNeeded(group);
    if(userDomMap[uid]){
      const prev = userDomMap[uid]; const el=prev.el;
      if(prev.group !== group){try{prev.el.remove();}catch(e){} const newEl=createUserElement(uid,userObj); groupDom.contentDiv.appendChild(newEl); userDomMap[uid]={el:newEl,group};}
      else{const nameDiv=el.querySelector('.name'); if(nameDiv) nameDiv.innerText=userObj.name||'Usuário'; const dot=el.querySelector('.status-dot'); if(dot) dot.style.backgroundColor=userObj.status==='online'?'green':userObj.status==='typing'?'yellow':'red';}
    } else{const el=createUserElement(uid,userObj); groupDom.contentDiv.appendChild(el); userDomMap[uid]={el,group};}
    updateGroupSelect();
  }

  function createUserElement(uid,userObj){
    const div=document.createElement('div'); div.className='contact'; div.dataset.uid=uid; div.dataset.name=userObj.name||'Usuário';
    const initial=(userObj.name && userObj.name[0])?userObj.name[0].toUpperCase():'?';
    const color=userObj.status==='online'?'green':userObj.status==='typing'?'yellow':'red';
    div.innerHTML=`<div class="avatar">${initial}<div class="status-dot" style="background-color:${color}"></div></div><div class="name">${userObj.name||'Usuário'}</div><div class="unread-count" id="unread-${uid}"></div>`;
    div.addEventListener('click',()=>{
      const myUid=auth.currentUser.uid; const otherUid=uid;
      const chatId=myUid<otherUid?`${myUid}_${otherUid}`:`${otherUid}_${myUid}`;
      currentChat = chatId;
      openChat(chatId,userObj.name||'Usuário'); 
      resetUnread(uid);
    });
    return div;
  }

  function removeUser(uid){const stored=userDomMap[uid]; if(stored && stored.el){try{stored.el.remove();}catch(e){} delete userDomMap[uid]; updateGroupSelect();}}

  const usersRef = ref(db,'users');
  usersListenerRefs.push(onChildAdded(usersRef,snap=>addOrUpdateUser(snap.key,snap.val())));
  usersListenerRefs.push(onChildChanged(usersRef,snap=>addOrUpdateUser(snap.key,snap.val())));
  usersListenerRefs.push(onChildRemoved(usersRef,snap=>removeUser(snap.key)));
}

/* ---------- SELECT BOX ---------- */
function updateGroupSelect(){
  const select = document.getElementById('groupSelect');
  select.innerHTML='';
  groupsMap.forEach((v, groupName)=>{
    const option = document.createElement('option'); option.value=groupName; option.innerText=groupName; select.appendChild(option);
  });
  select.value = currentGroup;
}

function showTab(groupName){
  groupsMap.forEach((v,key)=>{v.contentDiv.style.display=(key===groupName)?'block':'none';});
  currentGroup = groupName;
  updateGroupSelect();
}

document.getElementById('groupSelect').addEventListener('change',(e)=>{showTab(e.target.value);});

/* ---------- CONTADOR DE MENSAGENS ---------- */
function incrementUnread(chatId){
  const unreadDivId = (chatId==='Chat Público')?'unread-public':'unread-'+chatId;
  const unreadDiv = document.getElementById(unreadDivId);
  if(!unreadDiv) return;
  let count = parseInt(unreadDiv.innerText||'0')+1;
  unreadDiv.innerText = count;
  unreadDiv.style.display = 'block';
}
function resetUnread(chatId){
  const unreadDivId = (chatId==='Chat Público')?'unread-public':'unread-'+chatId;
  const unreadDiv = document.getElementById(unreadDivId);
  if(!unreadDiv) return;
  unreadDiv.innerText='';
  unreadDiv.style.display='none';
}

/* ---------- CHAT ---------- */
function openChat(chatId,chatName){
  currentChat=chatId; document.getElementById('chatHeader').innerText=chatName;
  document.getElementById('contactsListContent').parentElement.style.display='none';
  document.getElementById('chat').style.display='flex';
  document.getElementById('chatMessages').innerHTML='';
  resetUnread(chatId);

  if(messagesListenerUnsub) messagesListenerUnsub();
  const messagesRef=ref(db,'messages');
  messagesListenerUnsub = onChildAdded(messagesRef,snap=>{
    const msg = snap.val(); if(!msg) return;
    if(msg.chat===currentChat||(currentChat==='Chat Público' && msg.chat==='Chat Público')) renderMessage(msg);
    else incrementUnread(msg.chat);
  });
}

function renderMessage(msg){
  const chatMessagesDiv=document.getElementById('chatMessages');
  const container=document.createElement('div'); container.className='message-container '+(msg.user===auth.currentUser?.uid?'sent':'received');

  if(msg.user!==auth.currentUser?.uid){
    const sender=document.createElement('div'); sender.className='sender-name'; sender.innerText=msg.username||'Usuário';
    container.appendChild(sender);
    if(msg.status==='typing'){const typing=document.createElement('span'); typing.className='typing-indicator'; sender.appendChild(typing);}
  }

  const txt=document.createElement('div'); txt.className='message '+(msg.user===auth.currentUser?.uid?'sent':'received'); txt.innerText=msg.text||''; container.appendChild(txt);

  const timeDiv=document.createElement('div'); timeDiv.className='message-time'; const d=new Date(msg.timestamp||Date.now()); timeDiv.innerText=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; container.appendChild(timeDiv);

  chatMessagesDiv.appendChild(container); container.scrollIntoView({behavior:'smooth'});
}

/* ---------- ENVIAR MENSAGEM ---------- */
function sendMessage(){
  const textEl=document.getElementById('messageInput'); const text=textEl.value.trim();
  if(!text||!currentChat||!auth.currentUser) return;
  push(ref(db,'messages'),{text,username:currentUserName||'Usuário',user:auth.currentUser.uid,chat:currentChat,timestamp:Date.now()});
  textEl.value=''; updateTypingStatus(false);
}

/* ---------- TYPING INDICATOR ---------- */
const messageInput=document.getElementById('messageInput');
messageInput.addEventListener('input',()=>updateTypingStatus(true));
function updateTypingStatus(isTyping){
  if(!auth.currentUser) return;
  const statusRef=ref(db,'users/'+auth.currentUser.uid+'/status');
  set(statusRef,isTyping?'typing':'online');
  clearTimeout(typingTimeout);
  if(isTyping) typingTimeout=setTimeout(()=>set(statusRef,'online'),2000);
}

/* ---------- LIMPAR MENSAGENS ---------- */
function clearChat(){if(!confirm('Deseja apagar todas as mensagens do banco (isto apaga todas as conversas)?')) return; remove(ref(db,'messages')); document.getElementById('chatMessages').innerHTML='';}

/* ---------- EVENTOS UI ---------- */
document.getElementById('showRegisterLink').addEventListener('click',showRegister);
document.getElementById('showLoginLink').addEventListener('click',showLogin);
document.getElementById('registerBtn').addEventListener('click',registerUser);
document.getElementById('loginBtn').addEventListener('click',loginUser);
document.getElementById('logoutBtn').addEventListener('click',logout);
document.getElementById('sendMsgBtn').addEventListener('click',sendMessage);
document.getElementById('clearChatBtn').addEventListener('click',clearChat);
document.getElementById('closeChatBtn').addEventListener('click',()=>{document.getElementById('chat').style.display='none'; document.getElementById('contactsListContent').parentElement.style.display='block';});
document.getElementById('messageInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});
</script>
</body>
</html>
