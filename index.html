function appendMessage(msg, key){
  const chatMessagesDiv = document.getElementById('chatMessages');
  const container = document.createElement('div');
  container.classList.add('message-container', msg.user===auth.currentUser.uid?'sent':'received');

  const sender = document.createElement('div');
  sender.className = 'sender-name';
  sender.innerText = msg.username || 'Usuário';
  if(msg.user===auth.currentUser.uid) sender.style.display='none';
  container.appendChild(sender);

  const text = document.createElement('div');
  text.className = 'message';
  const readCount = msg.readBy ? msg.readBy.length : 0;
  text.setAttribute('data-read', readCount > 1 ? '✓✓' : '✓');
  text.innerText = msg.text;
  container.appendChild(text);

  const time = new Date(msg.timestamp);
  const timeDiv = document.createElement('div');
  timeDiv.className = 'message-time';
  timeDiv.innerText = `${time.getHours().toString().padStart(2,'0')}:${time.getMinutes().toString().padStart(2,'0')}`;
  container.appendChild(timeDiv);

  chatMessagesDiv.appendChild(container);
  container.scrollIntoView({behavior:'smooth'});

  // Marca como lida fora do onValue principal
  if(!msg.readBy) msg.readBy = [];
  if(!msg.readBy.includes(auth.currentUser.uid)){
    update(ref(db,'messages/'+key+'/readBy'), [...msg.readBy, auth.currentUser.uid]);
  }

  if(msg.user!==auth.currentUser.uid){
    playNotificationSound();
    showNotification(`Nova mensagem de ${msg.username}`, msg.text);
  }
}
