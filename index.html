<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Foundation Kaleosu</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', Tahoma, sans-serif; }
body { background-color: #121212; display: flex; justify-content: center; align-items: center; height: 100vh; color: #E1E1E1; }
.container { width: 100%; max-width: 480px; background-color: #1E1E1E; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.7); }
.form-container { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
input { padding: 10px; border-radius: 5px; border: 1px solid #333; outline: none; width: 100%; font-size: 14px; background-color: #2C2C2C; color: #E1E1E1; }
button { padding: 10px; border: none; border-radius: 5px; background-color: #075E54; color: #E1E1E1; font-weight: bold; cursor: pointer; transition: 0.2s; }
button:hover { background-color: #056162; }
.link { color: #075E54; text-align: center; cursor: pointer; font-size: 14px; }
.whatsapp-container { display: none; flex-direction: column; height: 100vh; }
.header { height: 60px; background-color: #1E1E1E; color: #E1E1E1; display: flex; align-items: center; padding: 0 15px; font-weight: bold; font-size: 18px; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
.contacts, .chat { flex: 1; overflow-y: auto; background-color: #121212; }
.contact { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; position: relative; }
.contact:hover { background-color: #2C2C2C; }
.contact .avatar { width: 50px; height: 50px; border-radius: 50%; background-color: #075E54; color: #E1E1E1; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px; margin-right: 10px; position: relative; }
.contact .status-dot { position: absolute; bottom: 4px; right: 4px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #1E1E1E; }
.contact .name { font-weight: bold; font-size: 16px; color: #E1E1E1; }
.chat { display: none; flex-direction: column; background-color: #121212; }
.chat-messages { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth; }
.message-container { margin-bottom: 12px; display: flex; flex-direction: column; max-width: 75%; word-wrap: break-word; white-space: pre-wrap; }
.message-container.sent { align-self: flex-end; }
.message-container.received { align-self: flex-start; }
.message-container .sender-name { font-size: 12px; font-weight: bold; color: #075E54; margin-bottom: 2px; }
.message-container .message { font-size: 14px; padding: 10px 14px; border-radius: 12px; display: inline-block; max-width: 100%; }
.message-container.sent .message { background-color: #056162; color: #E1E1E1; border-bottom-right-radius: 2px; padding-right: 30px; position: relative; }
.message-container.sent .message::after { content: attr(data-read); font-size: 10px; color: #E1E1E1; position: absolute; bottom: 4px; right: 8px; }
.message-container.received .message { background-color: #262D31; color: #E1E1E1; }
.message-container .message-time { font-size: 10px; color: #888; text-align: right; margin-top: 2px; }
.chat-input { display: flex; padding: 10px; background-color: #2C2C2C; border-top: 1px solid #333; }
.chat-input input { flex: 1; padding: 10px; border-radius: 25px; border: 1px solid #333; outline: none; font-size: 14px; background-color: #1E1E1E; color: #E1E1E1; }
.chat-input button { background-color: #075E54; color: #E1E1E1; border: none; padding: 10px 15px; margin-left: 5px; border-radius: 50%; cursor: pointer; transition: 0.2s; }
.chat-input button:hover { background-color: #056162; }
.clear-chat { margin-left: 10px; background-color: #B00020; border-radius: 5px; padding: 8px 12px; font-size: 14px; color: #E1E1E1; }
.clear-chat:hover { background-color: #900018; }
.typing { font-size:12px; color:#E1E1E1; margin-bottom:5px; font-style: italic; }
</style>
</head>
<body>
<div class="container">

  <!-- Login -->
  <div id="loginForm" class="form-container">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Senha">
    <button onclick="loginUser()">Entrar</button>
    <div class="link" onclick="showRegister()">Criar conta</div>
  </div>

  <!-- Cadastro -->
  <div id="registerForm" class="form-container" style="display:none;">
    <h2>Cadastro</h2>
    <input type="text" id="regName" placeholder="Nome de usu√°rio">
    <input type="email" id="regEmail" placeholder="Email">
    <input type="password" id="regPassword" placeholder="Senha">
    <button onclick="registerUser()">Cadastrar</button>
    <div class="link" onclick="showLogin()">J√° tem conta? Entrar</div>
  </div>

  <!-- Foundation Kaleosu -->
  <div class="whatsapp-container" id="whatsappApp">
    <div class="header">
      <span>Foundation Kaleosu</span>
      <div>
        <button onclick="logout()" style="background:none; color:#E1E1E1; font-size:16px; border:none; cursor:pointer;">Sair</button>
        <button class="clear-chat" onclick="clearChat()">Apagar Chat</button>
      </div>
    </div>

    <div class="contacts" id="contactsList"></div>

    <div class="chat" id="chat">
      <div class="header">
        <span id="chatHeader">Chat P√∫blico</span>
        <button onclick="closeChat()" style="background:none; color:#E1E1E1; font-size:18px; border:none; cursor:pointer;">‚úñ</button>
      </div>
      <div class="typing" id="typingIndicator" style="display:none;">Digitando...</div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Digite uma mensagem..." oninput="sendTyping()">
        <button onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, get, set, remove, update, onValue } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMr3KcqWq358YvERVBkSqzDsqHnqsBqCw",
  authDomain: "chat-publico-foundation.firebaseapp.com",
  databaseURL: "https://chat-publico-foundation-default-rtdb.firebaseio.com",
  projectId: "chat-publico-foundation",
  storageBucket: "chat-publico-foundation.appspot.com",
  messagingSenderId: "1028294779813",
  appId: "1:1028294779813:web:a5fbdc8f5a7bb6c91abe4c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();
const messaging = getMessaging(app);
let currentUserName = '';
let currentChat = '';
let messagesListener;
let typingTimeout;

// ‚úÖ Registrar service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/firebase-messaging-sw.js')
  .then(reg => console.log('‚úÖ SW registrado:', reg))
  .catch(err => console.error('‚ùå Falha SW:', err));
}

// ‚úÖ Pedir permiss√£o de notifica√ß√µes
async function requestNotificationPermission() {
  try {
    const permission = await Notification.requestPermission();
    if(permission === 'granted'){
      const token = await getToken(messaging, {
        vapidKey: "BG-HAG8bZewCqHW19SNiRtBnX_3dlmno6uuHRbhwT_Iqjj5PwpfvRNIvPvmB0iQ4PAn9ppeAT0tg5D3ZlRw7mnY"
      });
      if(token) await set(ref(db,'users/'+auth.currentUser.uid+'/notificationToken'),token);
      console.log('üîë Token FCM:', token);
    }
  } catch(e){console.error('Erro notifica√ß√£o:', e);}
}

// Mensagem em primeiro plano
onMessage(messaging,(payload)=>{
  const title = payload.notification?.title || 'Nova Mensagem';
  const body = payload.notification?.body || 'Voc√™ recebeu uma mensagem';
  new Notification(title,{body});
});

// ‚úÖ Mant√©m usu√°rio logado
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const snapshot = await get(ref(db,'users/'+user.uid));
    currentUserName = snapshot.exists() ? snapshot.val().name || 'Usu√°rio' : 'Usu√°rio';
    document.getElementById('loginForm').style.display='none';
    document.getElementById('registerForm').style.display='none';
    document.getElementById('whatsappApp').style.display='flex';
    update(ref(db,'users/'+user.uid), {online:true});
    loadContacts();
    watchTyping();
    openChat('Public Chat','Chat P√∫blico');
    requestNotificationPermission();
  } else {
    document.getElementById('whatsappApp').style.display='none';
    showLogin();
  }
});

// ‚úÖ Notifica√ß√µes simples
function notifyUser(title, body){
  if(Notification.permission === "granted"){
    new Notification(title,{body});
  }
}

// Form toggles
function showRegister(){ document.getElementById('loginForm').style.display='none'; document.getElementById('registerForm').style.display='flex'; }
function showLogin(){ document.getElementById('loginForm').style.display='flex'; document.getElementById('registerForm').style.display='none'; }

// Cadastro
async function registerUser(){
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;
  if(!name||!email||!password){alert("Preencha todos os campos!");return;}
  try{
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    const user = userCredential.user;
    await set(ref(db,'users/'+user.uid),{name:name,email:email,online:false});
    alert(`Usu√°rio ${name} cadastrado!`);
    showLogin();
  }catch(e){alert(e.message);}
}

// Login
async function loginUser(){
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
  }catch(e){alert(e.message);}
}

// Logout
function logout(){
  const uid = auth.currentUser.uid;
  update(ref(db,'users/'+uid), {online:false});
  signOut(auth);
}

// Contatos
function loadContacts(){
  const usersRef = ref(db,'users');
  onValue(usersRef, snapshot => {
    const users = snapshot.val();
    const contactsList = document.getElementById('contactsList');
    contactsList.innerHTML = '';
    contactsList.innerHTML+=`<div class="contact" onclick="openChat('Public Chat','Chat P√∫blico')">
      <div class="avatar">C</div>
      <div class="name">Chat P√∫blico</div>
    </div>`;
    const currentUserId = auth.currentUser.uid;
    let usersArray = [];
    for(let uid in users){
      if(uid === currentUserId) continue;
      usersArray.push({uid:uid,name:users[uid].name,online:users[uid].online});
    }
    usersArray.sort((a,b)=>a.name.localeCompare(b.name));
    usersArray.forEach(u=>{
      contactsList.innerHTML+=`<div class="contact" onclick="openPrivateChat('${u.uid}','${u.name}')">
        <div class="avatar">${u.name.charAt(0).toUpperCase()}
          <div class="status-dot" style="background-color:${u.online?'#00FF00':'#FF0000'}"></div>
        </div>
        <div class="name">${u.name}</div>
      </div>`;
    });
  });
}

// Abrir chat privado
function openPrivateChat(otherUid,otherName){
  const myUid = auth.currentUser.uid;
  const chatId = myUid < otherUid ? `${myUid}_${otherUid}` : `${otherUid}_${myUid}`;
  openChat(chatId,otherName);
}

// Abrir chat
function openChat(chatId,chatName){
  currentChat = chatId;
  document.getElementById('chatHeader').innerText = chatName;
  document.getElementById('contactsList').style.display='none';
  document.getElementById('chat').style.display='flex';
  document.getElementById('chatMessages').innerHTML='';
  document.getElementById('typingIndicator').style.display='none';

  if(messagesListener) messagesListener();

  const messagesRef = ref(db,'messages');
  messagesListener = onChildAdded(messagesRef,(snapshot)=>{
    const msg = snapshot.val();
    if(msg.chat===currentChat){
      const container = document.createElement('div');
      container.classList.add('message-container');
      container.classList.add(msg.user===auth.currentUser.uid?'sent':'received');

      const sender = document.createElement('div');
      sender.classList.add('sender-name');
      sender.innerText = msg.username || 'Usu√°rio';
      if(msg.user===auth.currentUser.uid) sender.style.display='none';
      container.appendChild(sender);

      const text = document.createElement('div');
      text.classList.add('message');
      const readCount = msg.readBy ? msg.readBy.length : 0;
      text.setAttribute('data-read', readCount>1 ? '‚úì‚úì' : '‚úì');
      text.innerText = msg.text;
      container.appendChild(text);

      const time = new Date(msg.timestamp);
      const hours = time.getHours().toString().padStart(2,'0');
      const minutes = time.getMinutes().toString().padStart(2,'0');
      const timeDiv = document.createElement('div');
      timeDiv.classList.add('message-time');
      timeDiv.innerText = `${hours}:${minutes}`;
      container.appendChild(timeDiv);

      document.getElementById('chatMessages').appendChild(container);
      container.scrollIntoView({behavior:'smooth'});

      // Marcar como lida
      if(!msg.readBy) msg.readBy=[];
      if(!msg.readBy.includes(auth.currentUser.uid)){
        const readRef = ref(db,'messages/'+snapshot.key+'/readBy');
        set(readRef,[...msg.readBy, auth.currentUser.uid]);
      }

      // Notifica√ß√£o se for mensagem de outra pessoa
      if(msg.user !== auth.currentUser.uid){
        notifyUser("Nova mensagem de " + (msg.username || "Usu√°rio"), msg.text);
      }
    }
  });
}

// Enviar mensagem
function sendMessage(){
  const input = document.getElementById('messageInput');
  const msg = input.value.trim();
  if(!msg) return;
  push(ref(db,'messages'),{
    chat: currentChat,
    user: auth.currentUser.uid,
    username: currentUserName || 'Usu√°rio',
    text: msg,
    timestamp: Date.now(),
    readBy:[auth.currentUser.uid]
  });
  input.value='';
}

// Indicador de digita√ß√£o
function sendTyping(){
  const typingRef = ref(db,'typing/'+currentChat+'/'+auth.currentUser.uid);
  set(typingRef,true);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{ set(typingRef,false); },1000);
}

function watchTyping(){
  const typingRef = ref(db,'typing');
  onValue(typingRef, snapshot=>{
    const typingUsers = snapshot.val() || {};
    const chatTyping = typingUsers[currentChat] || {};
    const othersTyping = Object.keys(chatTyping).filter(uid=>uid !== auth.currentUser.uid && chatTyping[uid]);
    document.getElementById('typingIndicator').style.display = othersTyping.length ? 'block' : 'none';
  });
}

// Fechar chat
function closeChat(){ document.getElementById('chat').style.display='none'; document.getElementById('contactsList').style.display='block'; }

// Limpar chat GLOBAL
function clearChat(){
  if(confirm('Apagar TODAS as mensagens deste chat para todos?')){
    const messagesRef = ref(db,'messages');
    onValue(messagesRef,snap=>{
      snap.forEach(child=>{
        const msg = child.val();
        if(msg.chat===currentChat){
          remove(ref(db,'messages/'+child.key));
        }
      });
    }, {onlyOnce:true});
    document.getElementById('chatMessages').innerHTML='';
  }
}

window.showRegister=showRegister; window.showLogin=showLogin;
window.registerUser=registerUser; window.loginUser=loginUser;
window.logout=logout; window.openChat=openChat;
window.closeChat=closeChat; window.sendMessage=sendMessage;
window.clearChat=clearChat; window.openPrivateChat=openPrivateChat;
window.loadContacts = loadContacts;
</script>
</body>
</html>
